<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã„ã‚“ã‚³ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 1rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .table-header th {
            padding: 0.75rem 1.5rem;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            background-color: #edf2f7;
            border-bottom: 2px solid #e2e8f0;
        }
        .table-row td {
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            color: #2d3748;
        }
        .table-row:last-child td {
            border-bottom: none;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.25rem;
            color: #6366f1;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-discord-incoin-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;

        // Job settings as defined in the Discord bot's main.js for display purposes
        const jobSettingsData = new Map([
            ["ç„¡è·", { display: "1,000 ã€œ 1,500 ã„ã‚“ã‚³ã‚¤ãƒ³" }],
            ["Youtuber", { display: "ä¿¡ç”¨ãƒã‚¤ãƒ³ãƒˆ Ã— (500 ã€œ 1,250) ã¾ãŸã¯ (10 ã€œ 100) ã„ã‚“ã‚³ã‚¤ãƒ³" }],
            ["ç¤¾é•·", { display: "(400,000 ã€œ 650,000) + (ãƒ¡ãƒ³ãƒãƒ¼æ•° Ã— 30,000) ã„ã‚“ã‚³ã‚¤ãƒ³" }],
            ["ãŠè‚‰å±‹", { display: "2,000 ã€œ 2,500 ã„ã‚“ã‚³ã‚¤ãƒ³" }],
            ["é­šå±‹", { display: "4,500 ã€œ 7,500 ã„ã‚“ã‚³ã‚¤ãƒ³" }],
            ["ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³åº—ä¸»", { display: "8,000 ã€œ 10,000 ã„ã‚“ã‚³ã‚¤ãƒ³" }],
            ["ã‚«ãƒ•ã‚§åº—ä¸»", { display: "12,000 ã€œ 13,000 ã„ã‚“ã‚³ã‚¤ãƒ³" }],
            ["ã‚¿ã‚¯ã‚·ãƒ¼é‹è»¢æ‰‹", { display: "17,500 ã€œ 23,000 ã„ã‚“ã‚³ã‚¤ãƒ³" }],
            ["ãƒã‚¹é‹è»¢æ‰‹", { display: "25,000 ã€œ 30,000 ã„ã‚“ã‚³ã‚¤ãƒ³" }],
            ["ãƒ›ãƒ†ãƒ«æ”¯é…äºº", { display: "45,000 ã€œ 60,000 ã„ã‚“ã‚³ã‚¤ãƒ³" }],
            ["ç§‘å­¦æŠ€è¡“è€…", { display: "70,000 ã€œ 80,000 ã„ã‚“ã‚³ã‚¤ãƒ³" }],
            ["å…¬èªä¼šè¨ˆå£«", { display: "85,000 ã€œ 100,000 ã„ã‚“ã‚³ã‚¤ãƒ³" }],
            ["æ­¯ç§‘åŒ»å¸«", { display: "115,000 ã€œ 130,000 ã„ã‚“ã‚³ã‚¤ãƒ³" }],
            ["åŒ»è€…", { display: "140,000 ã€œ 175,000 ã„ã‚“ã‚³ã‚¤ãƒ³" }],
            ["èˆªç©ºæ©Ÿæ“ç¸¦å£«", { display: "150,000 ã€œ 210,000 ã„ã‚“ã‚³ã‚¤ãƒ³" }]
        ]);

        document.addEventListener('DOMContentLoaded', async () => {
            if (!firebaseConfig) {
                console.error("Firebase config is not available. Cannot initialize Firebase.");
                document.getElementById('loading').textContent = 'Firebaseã®è¨­å®šãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚';
                return;
            }

            try {
                const firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Firebase authenticated with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Firebase authenticated anonymously.");
                }

                await fetchAndDisplayData();

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                document.getElementById('loading').textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
            }
        });

        async function fetchAndDisplayData() {
            document.getElementById('loading').style.display = 'block';

            try {
                // Fetch all user data
                const usersCollectionRef = collection(db, `artifacts/${appId}/public/data/discord_incoin_data`);
                const usersSnapshot = await getDocs(usersCollectionRef);
                const allUsers = [];
                const userNames = new Map(); // To store user IDs and their latest known usernames

                usersSnapshot.forEach(docSnap => {
                    const userData = docSnap.data();
                    const userId = docSnap.id;

                    // Ensure basic fields exist for display, providing defaults if missing
                    const balances = userData.balances || 0;
                    const bankBalances = userData.bankBalances || 0;
                    const totalCoins = balances + bankBalances;
                    const job = userData.job || 'ç„¡è·';
                    
                    allUsers.push({
                        id: userId,
                        username: userData.username || `ãƒ¦ãƒ¼ã‚¶ãƒ¼${userId.substring(0, 5)}`, // Fallback for username
                        balances: balances,
                        bankBalances: bankBalances,
                        totalCoins: totalCoins,
                        job: job
                    });
                    userNames.set(userId, userData.username || `ãƒ¦ãƒ¼ã‚¶ãƒ¼${userId.substring(0, 5)}`);
                });

                // Sort users by totalCoins for ranking
                allUsers.sort((a, b) => b.totalCoins - a.totalCoins);

                // Populate Ranking Table
                const rankingTableBody = document.getElementById('ranking-table-body');
                rankingTableBody.innerHTML = ''; // Clear dummy data
                allUsers.forEach((user, index) => {
                    const row = `
                        <tr class="table-row">
                            <td>${index + 1}</td>
                            <td>${user.username}</td>
                            <td>${user.balances.toLocaleString()}</td>
                            <td>${user.bankBalances.toLocaleString()}</td>
                            <td>${user.totalCoins.toLocaleString()}</td>
                        </tr>
                    `;
                    rankingTableBody.innerHTML += row;
                });

                // Populate Jobs Table
                const jobsTableBody = document.getElementById('jobs-table-body');
                jobsTableBody.innerHTML = ''; // Clear dummy data
                jobSettingsData.forEach((settings, jobName) => {
                    const row = `
                        <tr class="table-row">
                            <td>${jobName}</td>
                            <td>${settings.display}</td>
                        </tr>
                    `;
                    jobsTableBody.innerHTML += row;
                });


                // Fetch all company data
                const companiesCollectionRef = collection(db, `artifacts/${appId}/public/data/companies`);
                const companiesSnapshot = await getDocs(companiesCollectionRef);
                const allCompanies = [];

                companiesSnapshot.forEach(docSnap => {
                    const companyData = docSnap.data();
                    const companyId = docSnap.id;

                    // Ensure basic fields exist, providing defaults if missing
                    const ownerUsername = userNames.get(companyData.ownerId) || `ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ (ID: ${companyData.ownerId ? companyData.ownerId.substring(0, 5) : 'ä¸æ˜'})`;
                    const membersCount = companyData.members ? companyData.members.length : 0;

                    allCompanies.push({
                        id: companyId,
                        name: companyData.name || 'ä¸æ˜ãªä¼šç¤¾',
                        owner: ownerUsername,
                        dailySalary: companyData.dailySalary || 0,
                        budget: companyData.budget || 0,
                        membersCount: membersCount,
                        autoDeposit: companyData.autoDeposit ? 'ON' : 'OFF'
                    });
                });

                // Populate Companies Table
                const companiesTableBody = document.getElementById('companies-table-body');
                companiesTableBody.innerHTML = ''; // Clear dummy data
                allCompanies.forEach(company => {
                    const row = `
                        <tr class="table-row">
                            <td>${company.name}</td>
                            <td>${company.owner}</td>
                            <td>${company.dailySalary.toLocaleString()}</td>
                            <td>${company.budget.toLocaleString()}</td>
                            <td>${company.membersCount}</td>
                            <td>${company.autoDeposit}</td>
                        </tr>
                    `;
                    companiesTableBody.innerHTML += row;
                });

            } catch (error) {
                console.error("Error fetching data from Firestore:", error);
                document.getElementById('loading').textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼: ' + error.message;
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
    </script>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold text-center text-indigo-700 mb-8 rounded-lg bg-white p-4 shadow-lg">ã„ã‚“ã‚³ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

        <div id="loading" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

        <!-- æ‰€æŒé‡‘ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-indigo-600 mb-4 pb-2 border-b-2 border-indigo-200">æ‰€æŒé‡‘ãƒ©ãƒ³ã‚­ãƒ³ã‚° ğŸ†</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th class="rounded-tl-lg">é †ä½</th>
                            <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                            <th>æ‰€æŒé‡‘</th>
                            <th>éŠ€è¡Œé é‡‘</th>
                            <th class="rounded-tr-lg">åˆè¨ˆ</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-table-body">
                        <!-- Data will be loaded here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- è·æ¥­ã®ç¨®é¡ -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-indigo-600 mb-4 pb-2 border-b-2 border-indigo-200">è·æ¥­ã®ç¨®é¡ ğŸ’¼</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th class="rounded-tl-lg">è·æ¥­å</th>
                            <th class="rounded-tr-lg">åå…¥ç¯„å›²</th>
                        </tr>
                    </thead>
                    <tbody id="jobs-table-body">
                        <!-- Data will be loaded here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ä¼šç¤¾ã®ç¨®é¡ -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-indigo-600 mb-4 pb-2 border-b-2 border-indigo-200">ä¼šç¤¾ã®ç¨®é¡ ğŸ¢</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th class="rounded-tl-lg">ä¼šç¤¾å</th>
                            <th>ã‚ªãƒ¼ãƒŠãƒ¼</th>
                            <th>æ—¥çµ¦</th>
                            <th>äºˆç®—</th>
                            <th>ãƒ¡ãƒ³ãƒãƒ¼æ•°</th>
                            <th class="rounded-tr-lg">è‡ªå‹•å…¥é‡‘</th>
                        </tr>
                    </thead>
                    <tbody id="companies-table-body">
                        <!-- Data will be loaded here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>
